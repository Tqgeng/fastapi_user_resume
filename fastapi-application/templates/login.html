{% extends "base.html" %}
{% block title %}Вход — Resume App{% endblock %}

{% block content %}
<section class="container">
  <h1>Войти</h1>
  <form id="login-form" class="card" style="max-width:420px;">
    <label>
      Email
      <input type="email" id="email" required placeholder="you@example.com" />
    </label>
    <label>
      Пароль
      <input type="password" id="password" required placeholder="••••••••" />
    </label>

    <button type="submit" class="btn btn--primary" style="width:100%; margin-top:0.75rem;">Войти</button>
    <p id="login-error" style="color:#b91c1c; margin-top:0.75rem; display:none;"></p>

    <p style="margin-top:1rem;">
      Нет аккаунта? <a href="/register">Зарегистрируйтесь</a>
    </p>
  </form>
</section>
{% endblock %}

{% block scripts %}
<script>
  const LOGIN_URL = "/api/v1/auth/login";

  const form = document.getElementById("login-form");
  const errEl = document.getElementById("login-error");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errEl.style.display = "none";
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    try {
      const formData = new URLSearchParams();
      formData.append("username", email);
      formData.append("password", password);

      const res = await fetch(LOGIN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData.toString()
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || ("Ошибка входа: " + res.status));
      }

      const data = await res.json();
      const token = data.access_token || data.token || data.jwt;

      if (!token) throw new Error("Токен не получен. Проверь формат ответа API.");

      setToken(token);
      window.location.href = "/resumes";
    } catch (err) {
      errEl.textContent = err.message || "Не удалось войти";
      errEl.style.display = "block";
    }
  });
</script>
{% endblock %}
